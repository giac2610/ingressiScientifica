<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Backoffice Scientifica</ion-title>
  </ion-toolbar>
  
  <ion-toolbar>
    <ion-segment [(ngModel)]="selectedSegment">
      <ion-segment-button value="guests">
        <ion-icon name="people-outline"></ion-icon>
        <ion-label>Ospiti in Sede</ion-label>
      </ion-segment-button>
      <ion-segment-button value="startups">
        <ion-icon name="business-outline"></ion-icon>
        <ion-label>Gestione Startup</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <div *ngIf="selectedSegment === 'guests'">
    <h2 class="section-title">Ospiti Attualmente Presenti</h2>
    
    <ion-list>
      <ion-item *ngFor="let guest of activeGuests$ | async">
        <ion-label>
          <h2>{{ guest.name }}</h2>
          <p>Entrato: {{ guest.entryTime | date:'dd MMMM HH:mm' }}</p>
          <p>Motivo: {{ guest.reason }}</p>
        </ion-label>
        
        <ion-badge slot="end" color="success">IN</ion-badge>
        
        <ion-button slot="end" fill="outline" color="warning" (click)="checkOut(guest.id!)">
          <ion-icon slot="icon-only" name="log-out-outline"></ion-icon>
        </ion-button>
      </ion-item>

      <ion-item *ngIf="(activeGuests$ | async)?.length === 0">
        <ion-label class="ion-text-center">
          <p>Nessun ospite presente al momento.</p>
        </ion-label>
      </ion-item>
    </ion-list>
  </div>
  <div *ngIf="selectedSegment === 'startups'">
    
    <ion-grid>
      <ion-row>
        
        <ion-col size="12" size-md="6">
          <ion-card>
            <ion-card-header>
              <ion-card-title>1. Nuova Startup</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item>
                <ion-input label="Nome Startup" labelPlacement="floating" [(ngModel)]="newStartupName"></ion-input>
              </ion-item>
              <ion-item>
                <ion-textarea label="Descrizione" labelPlacement="floating" [(ngModel)]="newStartupDesc"></ion-textarea>
              </ion-item>
              
              <div class="drop-zone" (drop)="onDrop($event, 'startup')" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)">
                <div *ngIf="!newStartupLogo" class="placeholder">
                  <ion-icon name="cloud-upload-outline" style="font-size: 30px;"></ion-icon>
                  <p>Trascina il Logo qui<br>o incolla un Link sotto</p>
                </div>
                <img *ngIf="newStartupLogo" [src]="newStartupLogo" class="preview-img">
              </div>

              <ion-item>
                <ion-input label="Oppure Link Logo" labelPlacement="floating" [(ngModel)]="newStartupLogo"></ion-input>
              </ion-item>

              <ion-button expand="block" class="ion-margin-top" (click)="addStartup()" [disabled]="!newStartupName">
                Crea Startup
              </ion-button>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-card>
            <ion-card-header>
              <ion-card-title>2. Gestisci Team</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              
              <ion-item class="ion-margin-bottom">
                <ion-select label="Seleziona Startup" labelPlacement="floating" [(ngModel)]="selectedStartupId">
                  <ion-select-option *ngFor="let s of startups$ | async" [value]="s.id">
                    {{ s.name }}
                  </ion-select-option>
                </ion-select>
              </ion-item>

              <div *ngIf="selectedStartupId">
                
                <div style="background: #f4f5f8; padding: 10px; border-radius: 8px;">
                  <ion-item lines="none" style="--background:transparent">
                    <ion-input label="Nome Dipendente" labelPlacement="stacked" [(ngModel)]="newEmpName"></ion-input>
                  </ion-item>
                  <ion-item lines="none" style="--background:transparent">
                    <ion-input label="Ruolo" labelPlacement="stacked" [(ngModel)]="newEmpRole"></ion-input>
                  </ion-item>
                  
                  <div class="drop-zone small" 
                      (drop)="onDrop($event, 'employee')" 
                      (dragover)="onDragOver($event)" 
                      (dragleave)="onDragLeave($event)">
                    <p *ngIf="!newEmpImage" style="margin:0; color:#666">Trascina foto qui</p>
                    <img *ngIf="newEmpImage" [src]="newEmpImage" style="height:50px; border-radius:50%">
                  </div>

                  <ion-button expand="block" size="small" class="ion-margin-top" (click)="addEmployee()" [disabled]="!newEmpName">
                    <ion-icon slot="start" name="person-add-outline"></ion-icon>
                    Aggiungi
                  </ion-button>
                </div>

                <h5 class="ion-margin-top">Team Attuale:</h5>
                <ng-container *ngFor="let s of startups$ | async">
                  <ion-list *ngIf="s.id === selectedStartupId">
                    <ion-item *ngFor="let emp of s.employees">
                      <ion-avatar slot="start">
                        <img [src]="emp.imageUrl || 'https://via.placeholder.com/40'">
                      </ion-avatar>
                      <ion-label>
                        <h3>{{ emp.name }}</h3>
                        <p>{{ emp.role }}</p>
                      </ion-label>
                      <ion-button slot="end" fill="clear" color="danger" (click)="deleteEmployee(emp)">
                        <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                      </ion-button>
                    </ion-item>
                    <div *ngIf="!s.employees.length" class="ion-text-center">
                      <small>Nessun dipendente.</small>
                    </div>
                  </ion-list>
                </ng-container>

              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>

      </ion-row>

      <ion-row>
        <ion-col size="12">
          <h3>Riepilogo Startup</h3>
          <ion-list>
            <ion-item *ngFor="let s of startups$ | async">
              <ion-avatar slot="start">
                <img [src]="s.logoUrl || 'https://via.placeholder.com/50'" />
              </ion-avatar>
              <ion-label>
                <h2>{{ s.name }}</h2>
                <p>Dipendenti: {{ s.employees.length || 0 }}</p>
              </ion-label>
              <ion-button fill="clear" color="danger" (click)="deleteStartup(s.id!)">
                <ion-icon name="trash-outline"></ion-icon>
              </ion-button>
            </ion-item>
          </ion-list>
        </ion-col>
      </ion-row>

    </ion-grid>
  </div>

</ion-content>