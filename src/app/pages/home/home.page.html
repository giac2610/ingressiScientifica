<ion-content [fullscreen]="true" class="transparent-bg">
    
  <canvas #backgroundCanvas class="background-canvas"></canvas>
  
  <div class="box-header" (click)="setView('main')">
    <div class="logo" data-maxheight="60">
      <img fetchpriority="high" decoding="async" src="https://scientifica.vc/wp-content/uploads/2025/05/Favicon-Scientifica_Positive.png" alt="logo" class="img-responsive" data-cmp-info="10">
    </div>
  
  </div>
  <!-- MAIN MENU -->
  <div class="menu-wrapper" [class.active]="currentView === 'main'">
    <ion-grid class="center-grid">
      <ion-row>
        <ion-card (click)="setView('startup')">
          Utenti Startup
        </ion-card>
        <ion-card (click)="setView('utenti3')">
          Utenti Terzi
        </ion-card>
      </ion-row>
      <ion-row>
        <ion-card (click)="setView('guestsHome')">
          Visitatori
        </ion-card>
        <ion-card (click)="setView('fornitori')">
          Fornitori
        </ion-card>
      </ion-row>
    </ion-grid>
  </div>
  <!-- STARTUP -->
<div class="menu-wrapper" [class.active]="currentView === 'startup'">
    <ion-grid class="center-grid">
      
      <ion-row style="justify-content: center;">
        
        @for (s of startup$ | async; track s.id) {
          <ion-col size="6" size-md="6">
            
            <ion-card 
              (click)="selectStartup(s)" 
              class="startup-card"
              [style.--background]="s.logoUrl ? 'url(' + s.logoUrl + ') no-repeat center/contain' : 'rgba(255,255,255,0.8)'"
              style="background-origin: content-box; padding: 20px;">
              
              <ion-card-content *ngIf="!s.logoUrl" style="color: #333; font-weight: bold; font-size: 1.5em;">
                {{ s.name }}
              </ion-card-content>
            
            </ion-card>
          </ion-col>
        } @empty {
          <p style="color: white;">Caricamento startup...</p>
        }

      </ion-row>
    </ion-grid>
  </div>

  <div class="menu-wrapper" [class.active]="currentView === 'startupEmployees'">
    <ion-card class="input-card" style="max-width: 700px;">
      
      <ion-card-header>
        <ion-card-title>
          {{ selectedStartup?.name }} - Team
        </ion-card-title>
        <ion-searchbar 
          placeholder="Cerca collega..." 
          animated="true"
          debounce="300"
          (ionInput)="handleEmployeeSearch($event)">
        </ion-searchbar>
      </ion-card-header>

      <ion-card-content>
        
        <ng-container *ngIf="activeGuests$ | async as activeGuests">
          
          <ion-grid>
            <ion-row>
              @for (emp of selectedStartup?.employees; track emp.name) {
                <ion-col size="6" size-sm="4">
                  
                  <div 
                    class="employee-badge" 
                    [class.is-present]="getActiveEntry(emp, activeGuests)"
                    (click)="toggleEmployeeEntry(emp, activeGuests)">
                    
                    <ion-avatar class="emp-avatar">
                      <img [src]="emp.imageUrl || 'https://ionicframework.com/docs/img/demos/avatar.svg'" />
                    </ion-avatar>
                    
                    <div class="emp-info">
                      <strong>{{ emp.name }}</strong>
                      <small>{{ emp.role }}</small>
                    </div>

                    <ion-badge [color]="getActiveEntry(emp, activeGuests) ? 'success' : 'medium'" style="margin-top: 5px;">
                      {{ getActiveEntry(emp, activeGuests) ? 'PRESENTE' : 'ENTRA' }}
                    </ion-badge>

                  </div>

                </ion-col>
              } @empty {
                <ion-col>
                  <p>Nessun dipendente registrato per questa azienda.</p>
                </ion-col>
              }
            </ion-row>
          </ion-grid>

        </ng-container>

        <ion-button fill="clear" (click)="setView('startup')" color="medium" expand="block">
          Torna alle Startup
        </ion-button>

      </ion-card-content>
    </ion-card>
  </div>
  <!-- GUESTS -->
  <div class="menu-wrapper" [class.active]="currentView === 'guestsHome'">
    <ion-grid class="center-grid">
      <ion-row>
        <ion-card (click)="setView('guestsData')">
          Accesso
        </ion-card>
        <ion-card (click)="setView('guestsExit')">
          Uscita
        </ion-card>
      </ion-row>
    </ion-grid>
  </div>
  <!-- GUESTSHOME - ACCESSO -->
  <div class="menu-wrapper" [class.active]="currentView === 'guestsData'">
    <ion-card class="input-card">
          <ion-card-header>
            <ion-card-title>Registrazione Ospite</ion-card-title>
          </ion-card-header>
          
          <ion-card-content>
            <ion-item class="custom-input">
              <ion-input label="Nome e Cognome" labelPlacement="floating" [(ngModel)]="guestName"></ion-input>
            </ion-item>

            <ion-item class="custom-input">
              <ion-select label="Motivazione Ingresso" labelPlacement="floating" [(ngModel)]="selectedReason" interface="popover">
                <ion-select-option *ngFor="let reason of reasons" [value]="reason">
                  {{ reason }}
                </ion-select-option>
              </ion-select>
            </ion-item>

            <div class="signature-trigger" (click)="openPrivacyModal()">
              <div class="signature-placeholder" [class.signed]="signatureImage">
                <p *ngIf="!signatureImage">Clicca qui per leggere l'informativa e firmare</p>
                <img *ngIf="signatureImage" [src]="signatureImage" alt="Firma Ospite" />
              </div>
              <div class="status-icon">
                <ion-icon [name]="signatureImage ? 'checkmark-circle' : 'create'"></ion-icon>
              </div>
            </div>

            <ion-button expand="block" class="submit-btn" [disabled]="!signatureImage || !guestName" (click)="setView('main')">
              Conferma Ingresso
            </ion-button>
            
            <ion-button fill="clear" color="medium" (click)="setView('main')">Annulla</ion-button>
          </ion-card-content>
        </ion-card>
  </div>

  <!-- GUEST USCITA -->
<div class="menu-wrapper" [class.active]="currentView === 'guestsExit'">
  <ion-card class="input-card">
    <ion-card-header>
      <ion-card-title>Ospiti Presenti</ion-card-title>
      
      <ion-searchbar 
        placeholder="Cerca ospite..." 
        animated="true"
        debounce="300"
        (ionInput)="handleSearch($event)">
      </ion-searchbar>

    </ion-card-header>

    <ion-content style="height: 300px">
      <ion-list>
        @for (guest of filteredGuests$ | async; track guest.id) {
          <ion-item>
            <ion-label>
              <h2>{{ guest.name }}</h2>
              <p>{{ guest.entryTime | date:'shortTime' }} - {{ guest.reason }}</p>
            </ion-label>
            
            <ion-button slot="end" color="warning" (click)="doCheckout(guest.id!)">
              Uscita
            </ion-button>
          </ion-item>
        } @empty {
          <ion-item>
            <ion-label class="ion-text-center">
              <p>Nessun ospite trovato.</p>
            </ion-label>
          </ion-item>
        }
      </ion-list>
    </ion-content>
  </ion-card>
</div>
  <!-- PRIVACY MODAL -->
  <ion-modal [isOpen]="isPrivacyModalOpen" (didDismiss)="closePrivacyModal()" (didPresent)="onModalDidPresent()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Accettazione Privacy</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closePrivacyModal()">Chiudi</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content class="ion-padding">
        <div class="privacy-text">
          <h3>Informativa sulla Sicurezza</h3>
          <p>
            Dichiaro di aver preso visione delle norme di sicurezza vigenti all'interno della struttura Scientifica...
            (Inserisci qui tutto il testo legale necessario).
          </p>
          <p>
            Accetto il trattamento dei dati personali ai fini della registrazione degli accessi...
          </p>
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Expedita, voluptas quasi corporis ratione voluptatibus, quia eum quos distinctio ipsa dolorem reiciendis adipisci totam beatae id vero molestias nisi alias quidem!
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Delectus, dignissimos. Temporibus ipsa laudantium, quidem quia libero ratione quibusdam repellat corporis sint amet ipsam tenetur esse earum molestias praesentium ea voluptatem!
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Ipsam, eum soluta? Ipsum, libero numquam delectus aut quae repellat, ratione accusamus adipisci, doloribus repellendus tenetur reiciendis quis quod? Quos, praesentium omnis.
        </div>

        <div class="signature-area">
          <p>Firma qui sotto:</p>
          <canvas #signatureCanvas 
            (mousedown)="startDrawing($event)" (touchstart)="startDrawing($event)"
            (mousemove)="moved($event)" (touchmove)="moved($event)"
            (mouseup)="endDrawing()" (touchend)="endDrawing()"
            class="signature-pad">
          </canvas>
          
          <ion-button size="small" fill="outline" color="medium" (click)="clearSignature()">
            Cancella Firma
          </ion-button>
        </div>
      </ion-content>

      <ion-footer>
        <ion-toolbar>
          <ion-row>

            <ion-col>
              <ion-button expand="block" color="success" (click)="acceptAndSign()">
                Firmando accetti l'informativa
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-toolbar>
      </ion-footer>
    </ng-template>
  </ion-modal>
</ion-content>