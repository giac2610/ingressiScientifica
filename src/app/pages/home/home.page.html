<ion-content [fullscreen]="true" class="transparent-bg">
    
  <canvas #backgroundCanvas class="background-canvas"></canvas>

  <!-- HEADER -->
  <div class="box-header" (click)="setView('main')">
    <div class="logo" data-maxheight="60">
      <img fetchpriority="high" decoding="async" src="https://scientifica.vc/wp-content/uploads/2025/05/Favicon-Scientifica_Positive.png" alt="logo" class="img-responsive" data-cmp-info="10">
    </div>
    <!-- <div class="backoffice">
      <h2 (click)="navigateToBackoffice()">Backoffice</h2>
    </div> -->
  </div>

  <!-- MAIN MENU -->
  <div class="menu-wrapper" [class.active]="currentView === 'main'">
    <ion-grid class="center-grid">
      <ion-row>
        <ion-card (click)="setView('startup')">
          Utenti Startup
        </ion-card>
        <ion-card (click)="setView('thirdParties')">
          Utenti Terzi
        </ion-card>
      </ion-row>
      <ion-row>
        <ion-card (click)="setView('guestsHome')">
          Visitatori
        </ion-card>
        <ion-card (click)="setView('fornitoriHome')">
          Fornitori
        </ion-card>
      </ion-row>
    </ion-grid>
  </div>

  <!-- SCELTA STARTUP -->
  <div class="menu-wrapper" [class.active]="currentView === 'startup'">
    <div class="vertical-scroll-container">
      <ion-grid class="center-grid">
        <ion-row class="startup-row">
          @for (s of startup$ | async; track s.id) {
            <ion-col size="6">
              
              <ion-card 
                (click)="selectStartup(s)" 
                class="startup-card"
                [style.--background]="s.logoUrl ? 'url(' + s.logoUrl + ') no-repeat center/contain' : 'rgba(255,255,255,0.8)'"
                style="background-origin: content-box; padding: 20px;">
                
                <ion-card-content *ngIf="!s.logoUrl" style="color: #333; font-weight: bold; font-size: 1.2em;">
                  {{ s.name }}
                </ion-card-content>
              </ion-card>
            </ion-col>
          } @empty {
            <ion-col size="12">
              <p style="color: white;">Nessuna startup trovata.</p>
            </ion-col>
          }
        </ion-row>
      </ion-grid>
    </div>
  </div>

<!-- STARTUP EMPLOYEES -->
  <div class="menu-wrapper" [class.active]="currentView === 'startupEmployees'">
    <ion-card class="input-card" style="max-width: 700px;">
      <ion-card-header>
        <ion-card-title>
          {{ selectedStartup?.name }} - Team
        </ion-card-title>
        <ion-searchbar 
          placeholder="Cerca collega..." 
          animated="true"
          debounce="300"
          (ionInput)="handleEmployeeSearch($event)">
        </ion-searchbar>
      </ion-card-header>

      <ion-card-content>
        <ng-container *ngIf="ActiveEmployeeResult$ | async as ActiveEmployeeResult">
          <ion-grid>
            <ion-row class="employees-row">
              @for (emp of filteredEmployees; track emp.name) {
                <ion-col size="6" size-sm="4">
                  <div 
                    class="employee-badge" 
                    [class.is-present]="emp.status === 'IN'"
                    (click)="toggleEmployeeEntry(emp)">
                    
                    <ion-avatar class="emp-avatar">
                      <img [src]="emp.imageUrl || 'https://ionicframework.com/docs/img/demos/avatar.svg'" />
                    </ion-avatar>
                    
                    <div class="emp-info">
                      <strong>{{ emp.name }}</strong>
                      <small>{{ emp.role }}</small>
                    </div>

                    <ion-badge [color]= "emp.status === 'IN' ? 'success' : 'medium'" style="margin-top: 5px;">
                      {{ emp.status === 'IN'  ? 'PRESENTE' : 'ENTRA' }}
                    </ion-badge>

                  </div>

                </ion-col>
              } @empty {
                <ion-col>
                  <p>Nessun dipendente registrato per questa azienda.</p>
                </ion-col>
              }
            </ion-row>
          </ion-grid>

        </ng-container>

        <ion-button fill="clear" (click)="setView('startup')" color="medium" expand="block">
          Torna alle Startup
        </ion-button>

      </ion-card-content>
    </ion-card>
  </div>

  <!-- GUESTS -->
  <div class="menu-wrapper" [class.active]="currentView === 'guestsHome'">
    <ion-grid class="center-grid">
      <ion-row>
        <ion-card (click)="setView('guestsData')">
          Accesso
        </ion-card>
        <ion-card (click)="setView('guestsExit')">
          Uscita
        </ion-card>
      </ion-row>
    </ion-grid>
  </div>

  <!-- GUEST ACCESSO -->
  <div class="menu-wrapper" [class.active]="currentView === 'guestsData'">
    <ion-card class="input-card">
          <ion-card-header>
            <ion-card-title>Registrazione Ospite</ion-card-title>
          </ion-card-header>
          
          <ion-card-content>
            <ion-item class="custom-input">
              <ion-input label="Nome e Cognome" labelPlacement="floating" [(ngModel)]="guestName"></ion-input>
            </ion-item>

            <ion-item class="custom-input">
              <ion-select label="Motivazione Ingresso" labelPlacement="floating" [(ngModel)]="selectedReason" interface="popover">
                <ion-select-option *ngFor="let reason of reasons$ | async" [value]="reason.text">
                  {{ reason.text }}
                </ion-select-option>
              </ion-select>
            </ion-item>

            <div class="signature-trigger" (click)="openPrivacyModal()">
              <div class="signature-placeholder" [class.signed]="signatureImage">
                <p *ngIf="!signatureImage">Clicca qui per leggere l'informativa e firmare</p>
                <img *ngIf="signatureImage" [src]="signatureImage" alt="Firma Ospite" />
              </div>
              <div class="status-icon">
                <ion-icon [name]="signatureImage ? 'checkmark-circle' : 'create'" [color]="signatureImage ? 'success' : 'warning'"></ion-icon>
              </div>
            </div>

            <ion-button expand="block" class="submit-btn" [disabled]="!signatureImage || !guestName" (click)="acceptAndSign()">
              Conferma Ingresso
            </ion-button>
            
            <ion-button fill="clear" color="medium" (click)="setView('main')">Annulla</ion-button>
          </ion-card-content>
        </ion-card>
  </div>

  <!-- GUEST USCITA -->
  <div class="menu-wrapper" [class.active]="currentView === 'guestsExit'">
    <ion-card class="fixed-header-card">
      <ion-card-header>
        <ion-card-title>Ospiti Presenti</ion-card-title>
        
        <ion-searchbar 
          placeholder="Cerca ospite..." 
          animated="true"
          debounce="300"
          (ionInput)="handleSearch($event)">
        </ion-searchbar>

      </ion-card-header>

      <ion-card-content>
        <ion-list>
          @for (guest of filteredGuests$ | async; track guest.id) {
            <ion-item>
              <ion-label>
                <h2>{{ guest.name }}</h2>
                <p>{{ guest.entryTime | date:'shortTime' }} - {{ guest.reason }}</p>
              </ion-label>
              
              <ion-button slot="end" color="warning" (click)="doCheckout(guest)">
                Uscita
              </ion-button>
            </ion-item>
          } @empty {
            <ion-item>
              <ion-label class="ion-text-center">
                <p>Nessun ospite trovato.</p>
              </ion-label>
            </ion-item>
          }
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- FORNITORI -->
  <div class="menu-wrapper" [class.active]="currentView === 'fornitoriHome'">
        <ion-grid class="center-grid">
      <ion-row>
        <ion-card (click)="setView('fornitoriAccess')">
          Accesso
        </ion-card>
        <ion-card (click)="setView('fornitoriExit')">
          Uscita
        </ion-card>
      </ion-row>
    </ion-grid>
  </div>
  <!-- ACCESSO FORNITORI -->
  <div class="menu-wrapper" [class.active]="currentView === 'fornitoriAccess'">
    <div class="vertical-scroll-container">
      <ion-grid class="center-grid">
        <ion-row class="startup-row">
          @for (sup of supplier$ | async; track sup.id) {
            <ion-col size="6">
              
              <ion-card 
                (click)="sup.status !== 'IN' ? checkInSupplier(sup) : showToast( sup.name + ' ha già effettuato l\'accesso', 'warning')"
                class="startup-card"
                [style.--background]="sup.logoUrl ? 'url(' + sup.logoUrl + ') no-repeat center/contain' : 'rgba(235,235,235,0.8)'"
                style="background-origin: content-box; padding: 20px;">

                
                <ion-card-content style="color: #333; font-weight: bold; font-size: 1.2em;">
                  <div *ngIf="sup.status === 'IN'" slot="end" class="live-indicator"></div>
                  @if (!sup.logoUrl){
                    {{ sup.name }}
                  }
                </ion-card-content>
              </ion-card>
            </ion-col>
          } @empty {
            <ion-col size="12">
              <p style="color: white;">Nessun fornitore trovato.</p>
            </ion-col>
          }
        </ion-row>
      </ion-grid>
    </div>

  </div>
  <!-- USCITA FORNITORI -->
  <div class="menu-wrapper" [class.active]="currentView === 'fornitoriExit'">
    <ion-card class="fixed-header-card">
      <ion-card-header>
        <ion-card-title>Fornitori Presenti</ion-card-title>
        
        <ion-searchbar 
          placeholder="Cerca fornitore..." 
          animated="true"
          debounce="300"
          (ionInput)="handleSupplierSearch($event)">
        </ion-searchbar>

      </ion-card-header>

      <ion-card-content>
        <ion-list>
          @for (sup of filteredSuppliers$ | async; track sup.id) {
            <ion-item>
              <ion-label>
                <h2>{{ sup.name }}</h2>
                <p> Ingresso: {{ sup.lastEntryTime | date:'shortTime' }}</p>
              </ion-label>
              
              <ion-button slot="end" color="warning" (click)="doSupplierCheckout(sup)">
                Uscita
              </ion-button>
            </ion-item>
          } @empty {
            <ion-item>
              <ion-label class="ion-text-center">
                <p>Nessun fornitore trovato.</p>
              </ion-label>
            </ion-item>
          }
        </ion-list>
      </ion-card-content>
    </ion-card>

  </div>
  <!-- DIPENDENT UTENTI TERZI -->
  <div class="menu-wrapper" [class.active]="currentView === 'thirdParties'">
    <div class="vertical-scroll-container">
      <ion-grid class="center-grid">
        <ion-row class="startup-row">
          @for (tp of thirdPartie$ | async; track tp.id) {
            <ion-col size="6">
              
              <ion-card 
                (click)="selectThirdParty(tp)" 
                class="startup-card"
                [style.--background]="tp.logoUrl ? 'url(' + tp.logoUrl + ') no-repeat center/contain' : 'rgba(255,255,255,0.8)'"
                style="background-origin: content-box; padding: 20px;">
                
                <ion-card-content *ngIf="!tp.logoUrl" style="color: #333; font-weight: bold; font-size: 1.2em;">
                  {{ tp.name }}
                </ion-card-content>
              </ion-card>
            </ion-col>
          } @empty {
            <ion-col size="12">
              <p style="color: white;">Nessun utente terzo trovato.</p>
            </ion-col>
          }
        </ion-row>
      </ion-grid>
    </div>
  </div>
  <div class="menu-wrapper" [class.active]="currentView === 'thirdPartyEmployees'">
    <ion-card class="input-card" style="max-width: 700px;">
      <ion-card-header>
        <ion-card-title>
          {{ selectedThirdPartie?.name }} - Dipendenti
        </ion-card-title>
        <ion-searchbar 
          placeholder="Cerca dipendente..." 
          animated="true"
          debounce="300"
          (ionInput)="handleTpEmployeeSearch($event)">
        </ion-searchbar>
      </ion-card-header>

      <ion-card-content>
        <ng-container *ngIf="activeTpEmployeeResult$ | async as ActiveTpEmployeeResult">
          <ion-grid>
            <ion-row class="employees-row">
              @for (emp of filteredTpEmployees; track emp.name) {
                <ion-col size="6" size-sm="4">
                  <div 
                    class="employee-badge" 
                    [class.is-present]="emp.status === 'IN'"
                    (click)="toggleTpEmployee(emp)">
                    
                    <ion-avatar class="emp-avatar">
                      <img [src]="emp.imageUrl || 'https://ionicframework.com/docs/img/demos/avatar.svg'" />
                    </ion-avatar>
                    
                    <div class="emp-info">
                      <strong>{{ emp.name }}</strong>
                    </div>

                    <ion-badge [color]= "emp.status === 'IN' ? 'success' : 'medium'" style="margin-top: 5px;">
                      {{ emp.status === 'IN'  ? 'PRESENTE' : 'ENTRA' }}
                    </ion-badge>

                  </div>

                </ion-col>
              } @empty {
                <ion-col>
                  <p>Nessun dipendente registrato per questa azienda.</p>
                </ion-col>
              }
            </ion-row>
          </ion-grid>

        </ng-container>

        <ion-button fill="clear" (click)="setView('thirdParties')" color="medium" expand="block">
          Torna agli Utenti Terzi
        </ion-button>

      </ion-card-content>
    </ion-card>
  </div>
  <!-- PRIVACY MODAL -->
  <ion-modal [isOpen]="isPrivacyModalOpen" (didDismiss)="closePrivacyModal()" (didPresent)="onModalDidPresent()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Accettazione Privacy</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closePrivacyModal()">Chiudi</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content class="ion-padding">
        <div class="pdf-viewer-container">
  
          <ng-container *ngIf="pdfObjectUrl; else noPdf">
            <!-- <iframe [src]="privacyPdfUrl" type="application/pdf" width="100%" hieght="100%" title="Privacy Policy"></iframe> -->
            <pdf-viewer
              [src]="pdfObjectUrl"
              [rotation]="0"
              [original-size]="false"
              [show-all]="true"
              [fit-to-page]="false"
              [zoom]="1"
              [zoom-scale]="'page-width'"
              [stick-to-page]="false"
              [render-text]="true"
              [external-link-target]="'blank'"
              [autoresize]="true"
              [show-borders]="false"
              style="display: block; height: 80vh;" 
            ></pdf-viewer>
          </ng-container>
  
          <ng-template #noPdf>
            <div class="pdf-error">
              <ion-icon name="alert-circle-outline"></ion-icon>
              <p>Nessuna informativa caricata</p>
            </div>
          </ng-template>

        </div>
        <div class="privacy-checks ion-margin-top">
          <ion-item lines="none" class="checkbox-item">
            <ion-checkbox slot="start" [(ngModel)]="checkConsense1" aria-label="Consenso 1"></ion-checkbox>
            <ion-label class="ion-text-wrap" style="font-size: 0.9em;">
              Dichiaro di aver letto e compreso il vincolo di riservatezza e le conseguenze legali in caso di violazione.
            </ion-label>
          </ion-item>

          <ion-item lines="none" class="checkbox-item">
            <ion-checkbox slot="start" [(ngModel)]="checkConsense2" aria-label="Consenso 2"></ion-checkbox>
            <ion-label class="ion-text-wrap" style="font-size: 0.9em;">
              Accetto il trattamento dei dati personali per le finalità di sicurezza descritte.
            </ion-label>
          </ion-item>
        </div>

        <div class="signature-area">
          <p>Firma qui sotto:</p>
          <canvas #signatureCanvas 
            (mousedown)="startDrawing($event)" (touchstart)="startDrawing($event)"
            (mousemove)="moved($event)" (touchmove)="moved($event)"
            (mouseup)="endDrawing()" (touchend)="endDrawing()"
            class="signature-pad">
          </canvas>
          
          <ion-button size="small" fill="outline" color="medium" (click)="clearSignature()">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            Cancella Firma
          </ion-button>
        </div>
      </ion-content>

      <ion-footer>
        <ion-toolbar>
          <ion-row>
            <ion-col>
                <ion-button expand="block" color="medium" (click)="closePrivacyModal()">Annulla</ion-button>
            </ion-col>
            <ion-col>
              <ion-button expand="block" color="success" [disabled]="!canProceed" (click)="closePrivacyModal()">
                Conferma Ingresso
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-toolbar>
      </ion-footer>
    </ng-template>
  </ion-modal>
</ion-content>