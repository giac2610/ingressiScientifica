name: Build backoffice Win/macOS with Electron

# Esegue il workflow a ogni push su main o pull request
on:
  push:
    branches:
      - backoffice
    tags:
      - 'v*.*.*'

  pull_request:
    branches:
      - backoffce

permissions:
  contents: write

jobs:
  build-electron:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # Puoi rimuovere macos-latest se non ti serve il Mac per ora
        os: [windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # 1. Installa dipendenze globali
      - name: Install Dependencies
        run: |
          npm ci
          npm install -g @ionic/cli

      # 2. Compila Angular/Ionic (Crea la cartella www)
      - name: Build Ionic App
        run: ionic build --prod --no-interactive

      # 3. Copia la cartella www dentro Electron
      - name: Sync Capacitor Electron
        run: npx cap sync electron

      # 4. WINDOWS: Compila e Crea Release
      - name: Build Windows
        if: matrix.os == 'windows-latest'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Token automatico
        run: |
          cd electron
          npm install
          npm run build
          npx electron-builder --win --config electron-builder.config.json -p always

      # 5. MAC: Compila e Crea Release
      # Nota: Senza certificato Apple a pagamento, l'app Mac sarà "non firmata"
      # e richiederà click destro -> Apri per avviarsi la prima volta.
      - name: Build Mac
        if: matrix.os == 'macos-latest'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd electron
          npm install
          npm run build
          npx electron-builder --mac --config electron-builder.config.json -p always
# jobs:
#   build-win:
#     runs-on: windows-latest

#     steps:
#       # 1️⃣ Recupera il codice
#       - uses: actions/checkout@v4

#       # 2️⃣ Setup Node.js
#       - uses: actions/setup-node@v4
#         with:
#           node-version: 20

#       # 3️⃣ Installa dipendenze npm
#       - name: Install dependencies
#         run: npm ci

#       # Install Ionic CLI
#       - name: Install Ionic CLI
#         run: npm install -g @ionic/cli

#       # 4️⃣ Build Ionic app
#       - name: Build Ionic App
#         run: ionic build --no-interactive

#       # 5️⃣ Sync Capacitor Electron
#       - name: Sync Capacitor Electron
#         run: npx cap sync electron

#       # 6️⃣ Build Electron Windows
#       - name: Build Electron Windows
#         env: 
#           GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         run: |
#           cd electron
#           npm install
#           npm run build
#           npx electron-builder --win --config electron-builder.config.json

#       # 7️⃣ Carica l’exe come artifact
#       - name: Upload Windows executable
#         uses: actions/upload-artifact@v4
#         with:
#           name: windows-exe
#           path: |
#             electron/dist/win-unpacked/
#             electron/dist/*.exe

#   release:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4
#       - name: Build Artifact
#         run: echo ${{ github.sha }} > release_info.txt
#       - name: Create GitHub Release
#         uses: softprops/action-gh-release@v2
#         if: startsWith(github.ref, 'refs/tags/')
#         with:
#           files: release_info.txt